pipeline {
    agent any

    environment {
        // Replace with your actual Docker Hub repository
        registry = "aymenbenabdallah2003/student-management" 
        registryCredential = 'dockerhub'
        dockerImage = ''
        K8S_NAMESPACE = 'devops'
    }

    stages {

        stage('git') {
            steps {
                echo 'pulling from github'
                // Ensure this URL is correct for your repository
                git branch: 'master', // Changed to master or main usually, check your repo
                    url: 'https://github.com/yass1120/avec-maven.git' // Reverted to the previous repo we were using, change to yours if needed
            }
        }

        stage('maven build') {
            steps {
                echo 'maven build'
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('testing with mockito') {
            steps {
                echo 'maven testing'
                sh 'mvn test'
            }
        }

        /* 
        // Uncomment if you have SonarQube configured
        stage('SonarQube Analysis') {
            steps {
                echo 'Running SonarQube analysis'
                withSonarQubeEnv('scanner') {
                    withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
                        sh """
                            mvn sonar:sonar \
                              -Dsonar.projectKey=student \
                              -Dsonar.projectName=student \
                              -Dsonar.token=$SONAR_TOKEN
                        """
                    }
                }
            }
        }
        */

        stage('Building our image') {
            steps {
                script {
                    // Building with the BUILD_NUMBER as tag
                    dockerImage = docker.build("${registry}:${BUILD_NUMBER}")
                }
            }
        }

        stage('Deploy our image') {
            steps {
                script {
                    docker.withRegistry('', registryCredential) {
                        dockerImage.push()
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    // Apply manifests
                    sh "kubectl apply -f k8s/ -n ${K8S_NAMESPACE}"
                    
                    // Update the deployment to use the specific image tag we just built
                    sh "kubectl set image deployment/student-management student-management=${registry}:${BUILD_NUMBER} -n ${K8S_NAMESPACE}"
                    
                    // Wait for rollout
                    sh "kubectl rollout status deployment/student-management -n ${K8S_NAMESPACE}"
                }
            }
        }
    }

    post {
        always {
            /* 
            // Jacoco report
            dir('learning-service') {
                publishHTML(target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: false,
                    keepAll: true,
                    reportDir: './target/site/jacoco',
                    reportFiles: 'index.html',
                    reportName: 'Jacoco Code Coverage Report'
                ])
            }
            */

             sh "kubectl get pods -n ${K8S_NAMESPACE}"
            
            /*
            // Email notification
            emailext(
                to: "dhiaeddine.trabelsi@esprit.tn",
                from: "Jenkins@example.com",
                replyTo: "Jenkins@example.com",
                mimeType: 'text/html',
                subject: "STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                body: """<p>STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
                         <p>Build Status: ${currentBuild.result}</p>
                         <p>Check console output at
                         <a href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.BUILD_NUMBER}]</a></p>""",
                attachmentsPattern: 'target/site/jacoco/*.html'
            )
            */
        }
    }
}
